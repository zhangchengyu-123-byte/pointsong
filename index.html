<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº’åŠ¨ç‚¹æ­Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            --accent: #ff0055;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* å®¹å™¨ï¼šæ¨¡æ‹Ÿæ‰‹æœºå±å¹•å®½åº¦ */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        /* éšè—æ‰€æœ‰è§†å›¾ï¼Œé€šè¿‡ JS åˆ‡æ¢ */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* é€šç”¨æŒ‰é’® */
        .btn-back {
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 16px;
            margin-bottom: 20px;
            cursor: pointer;
            padding: 10px 0;
        }

        /* === é¦–é¡µ === */
        .home-menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 80vh;
            justify-content: center;
        }
        .big-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s;
            border: 1px solid #444;
        }
        .big-card:active { transform: scale(0.98); background: #333; }
        .big-card h2 { margin: 0; font-size: 24px; }
        .big-card p { color: var(--text-sub); margin-top: 8px; }

        /* === ä¸»æ’­åˆ—è¡¨ (Grid) === */
        .anchor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3åˆ— */
            gap: 20px;
            margin-top: 20px;
        }
        .anchor-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .avatar-box {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            padding: 3px; /* è¾¹æ¡†é—´è· */
            background-clip: content-box;
            border: 3px solid transparent; /* é¢œè‰²ç”± JS æ§åˆ¶ */
            overflow: hidden;
            margin-bottom: 8px;
            transition: transform 0.1s;
        }
        .anchor-item:active .avatar-box { transform: scale(0.9); opacity: 0.8; }
        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #444; /* æ²¡å›¾æ—¶çš„åº•è‰² */
        }
        .anchor-name { font-size: 13px; text-align: center; color: var(--text-main); }

        /* === è¯¦æƒ…é¡µ & æ±‚ç­¾é¡µ === */
        .header-section { text-align: center; margin-bottom: 30px; }
        .header-avatar { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--accent); object-fit: cover; margin-bottom: 10px; }
        
        .action-btn {
            width: 100%;
            background: linear-gradient(135deg, #ff0055, #ff5500);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
            cursor: pointer;
            margin-bottom: 30px;
        }
        .action-btn:active { transform: scale(0.98); }

        .result-list { list-style: none; padding: 0; }
        .song-item {
            background: var(--card-bg);
            margin-bottom: 12px;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: 1px solid #333;
        }
        .song-item:active { background: #444; border-color: #666; }
        .song-info { display: flex; flex-direction: column; }
        .song-name { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
        .song-artist { font-size: 12px; color: var(--text-sub); }
        .copy-hint { font-size: 12px; color: var(--accent); }

        /* ç­¾æ–‡å¡ç‰‡ */
        .fortune-card {
            background: #ffd700;
            color: #000;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            transform: rotate(-1deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .fortune-title { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .fortune-text { font-size: 14px; line-height: 1.5; }

        /* Toast æç¤º */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            z-index: 999;
        }
    </style>
</head>
<body>

<div id="toast">âœ… å·²å¤åˆ¶ç‚¹æ­ŒæŒ‡ä»¤</div>

<div class="app-container">
    
    <div id="view-home" class="view active">
        <h1 style="text-align: center; margin-bottom: 30px;">ğŸµ ç‚¹æ­Œå°åŠ©æ‰‹</h1>
        <div class="home-menu">
            <div class="big-card" onclick="goToFortune()">
                <h2>ğŸ® èµ›åšæ±‚ç­¾</h2>
                <p>æµ‹è¿åŠ¿ Â· éšæœºå¬æ­Œ</p>
            </div>
            <div class="big-card" onclick="goToAnchorList()">
                <h2>ğŸ™ï¸ ä¸»æ’­æ­Œå•</h2>
                <p>æŸ¥åº“å­˜ Â· ä¸€é”®å¤åˆ¶</p>
            </div>
        </div>
    </div>

    <div id="view-anchor-list" class="view">
        <button class="btn-back" onclick="switchView('view-home')">â† è¿”å›é¦–é¡µ</button>
        <h2 style="margin-bottom: 20px;">é€‰æ‹©ä¸»æ’­</h2>
        <div class="anchor-grid" id="anchor-grid-container">
            <p style="color: #666;">æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>
    </div>

    <div id="view-anchor-detail" class="view">
        <button class="btn-back" onclick="switchView('view-anchor-list')">â† æ¢ä¸ªä¸»æ’­</button>
        
        <div class="header-section">
            <img id="detail-avatar" src="" class="header-avatar">
            <h2 id="detail-name">ä¸»æ’­å</h2>
            <p style="color: #666; font-size: 12px;">åº“ä¸­å…±æœ‰ <span id="song-count">0</span> é¦–æ­Œ</p>
        </div>

        <button class="action-btn" onclick="drawSongs()">ğŸ² éšæœºæŠ½å–ä¸‰é¦–</button>
        
        <p style="text-align: center; color: #666; font-size: 12px; margin-bottom: 10px;">â†“ ç‚¹å‡»æ­Œåå¤åˆ¶ â†“</p>
        <div id="song-result-list" class="result-list"></div>
    </div>

    <div id="view-fortune" class="view">
        <button class="btn-back" onclick="switchView('view-home')">â† è¿”å›</button>
        
        <div id="fortune-content" style="display: none;">
            <div class="fortune-card">
                <div style="font-size: 12px;">ä»Šæ—¥è¿åŠ¿</div>
                <div class="fortune-title" id="fortune-title">...</div>
                <div class="fortune-text" id="fortune-desc">...</div>
            </div>
            <div style="margin-top: 30px;">
                <h3 style="font-size: 16px; margin-bottom: 15px;">ğŸ’Š å¤„æ–¹æ­Œæ›²</h3>
                <div id="fortune-song-list" class="result-list"></div>
            </div>
        </div>

        <div id="fortune-loading" style="text-align: center; padding-top: 50px;">
            <div style="font-size: 40px;">ğŸ‹</div>
            <p>æ­£åœ¨æ‘‡ç­¾ç­’...</p>
        </div>
    </div>

</div>

<script>
    // --- çŠ¶æ€ç®¡ç† ---
    let allAnchors = [];
    let currentAnchorSongs = [];
    let fortuneData = [];
    let fortuneSongs = [];

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        // é¢„åŠ è½½ä¸»æ’­åˆ—è¡¨
        loadCSV('anchors.csv', function(data) {
            allAnchors = data;
            renderAnchorList();
        });
        // é¢„åŠ è½½æ±‚ç­¾æ•°æ®
        loadCSV('fortunes.csv', (data) => fortuneData = data);
        loadCSV('fortune_songs.csv', (data) => fortuneSongs = data);
    };

    // --- æ ¸å¿ƒå·¥å…·ï¼šè¯»å– CSV ---
    function loadCSV(file, callback) {
        Papa.parse(file, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if(results.data && results.data.length > 0) {
                    callback(results.data);
                } else {
                    console.error("æ–‡ä»¶è¯»å–ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯:", file);
                }
            },
            error: function(err) {
                console.error("æ— æ³•è¯»å–æ–‡ä»¶ (è¯·æ£€æŸ¥æ–‡ä»¶åæˆ–æœåŠ¡å™¨è®¾ç½®):", file);
                // alert("æ— æ³•è¯»å–æ•°æ®æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ä½¿ç”¨äº†æœ¬åœ°æœåŠ¡å™¨æˆ–GitHub Pagesã€‚");
            }
        });
    }

    // --- è§†å›¾åˆ‡æ¢ ---
    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    // --- é€»è¾‘ï¼šæ¸²æŸ“ä¸»æ’­åˆ—è¡¨ ---
    function goToAnchorList() {
        switchView('view-anchor-list');
    }

    function renderAnchorList() {
        const container = document.getElementById('anchor-grid-container');
        container.innerHTML = ''; // æ¸…ç©º

        allAnchors.forEach(anchor => {
            const item = document.createElement('div');
            item.className = 'anchor-item';
            // ä½¿ç”¨ CSS å˜é‡ä¼ é€’è¾¹æ¡†é¢œè‰²
            item.innerHTML = `
                <div class="avatar-box" style="border-color: ${anchor.color || '#fff'}">
                    <img src="${anchor.avatar || ''}" class="avatar-img" onerror="this.src='https://via.placeholder.com/100?text=User'">
                </div>
                <div class="anchor-name">${anchor.name}</div>
            `;
            item.onclick = () => openAnchorDetail(anchor);
            container.appendChild(item);
        });
    }

    // --- é€»è¾‘ï¼šä¸»æ’­è¯¦æƒ… & æŠ½æ­Œ ---
    function openAnchorDetail(anchor) {
        // è®¾ç½® UI
        document.getElementById('detail-name').innerText = anchor.name;
        document.getElementById('detail-avatar').src = anchor.avatar;
        document.getElementById('detail-avatar').style.borderColor = anchor.color;
        document.getElementById('song-result-list').innerHTML = ''; // æ¸…ç©ºæ—§ç»“æœ
        document.getElementById('song-count').innerText = '...';

        switchView('view-anchor-detail');

        // åŠ è½½è¯¥ä¸»æ’­çš„æ­Œå•æ–‡ä»¶
        loadCSV(anchor.file, function(songs) {
            currentAnchorSongs = songs;
            document.getElementById('song-count').innerText = songs.length;
        });
    }

    function drawSongs() {
        if (!currentAnchorSongs || currentAnchorSongs.length === 0) {
            alert('æ­Œå•åŠ è½½ä¸­æˆ–ä¸ºç©ºï¼');
            return;
        }

        // éšæœºå–3é¦– (å¦‚æœä¸æ»¡3é¦–ï¼Œå–å…¨éƒ¨)
        const count = Math.min(3, currentAnchorSongs.length);
        // æ´—ç‰Œç®—æ³•
        const shuffled = [...currentAnchorSongs].sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, count);

        renderSongList(selected, 'song-result-list');
    }

    // --- é€»è¾‘ï¼šæ±‚ç­¾ ---
    function goToFortune() {
        switchView('view-fortune');
        const content = document.getElementById('fortune-content');
        const loading = document.getElementById('fortune-loading');
        
        content.style.display = 'none';
        loading.style.display = 'block';

        // æ¨¡æ‹Ÿæ‘‡ç­¾åŠ¨ç”» 1.5ç§’
        setTimeout(() => {
            loading.style.display = 'none';
            content.style.display = 'block';
            runFortuneLogic();
        }, 1500);
    }

    function runFortuneLogic() {
        // 1. éšæœºç­¾æ–‡
        if (fortuneData.length === 0 || fortuneSongs.length === 0) {
            document.getElementById('fortune-title').innerText = "æ•°æ®ç¼ºå¤±";
            return;
        }
        const randomFortune = fortuneData[Math.floor(Math.random() * fortuneData.length)];
        
        // 2. éšæœº2é¦–æ­Œ
        const shuffledSongs = [...fortuneSongs].sort(() => 0.5 - Math.random());
        const randomSongs = shuffledSongs.slice(0, 2);

        // æ¸²æŸ“
        document.getElementById('fortune-title').innerText = randomFortune.title || randomFortune.gua;
        document.getElementById('fortune-desc').innerText = randomFortune.text;
        
        renderSongList(randomSongs, 'fortune-song-list');
    }

    // --- é€šç”¨ï¼šæ¸²æŸ“æ­Œå•åˆ—è¡¨ ---
    function renderSongList(songs, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        songs.forEach((song, index) => {
            const div = document.createElement('div');
            div.className = 'song-item';
            div.innerHTML = `
                <div class="song-info">
                    <span class="song-name">${song.name}</span>
                    <span class="song-artist">${song.artist}</span>
                </div>
                <span class="copy-hint">å¤åˆ¶</span>
            `;
            // ç‚¹å‡»å¤åˆ¶
            div.onclick = () => copyText(`ç‚¹æ­Œ ${song.name}`);
            container.appendChild(div);
        });
    }

    // --- é€šç”¨ï¼šå¤åˆ¶åŠŸèƒ½ ---
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`âœ… å·²å¤åˆ¶: ${text}`);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥', err);
            showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
        });
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    }
</script>

</body>
</html>